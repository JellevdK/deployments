# haproxy has an IPv6 address
- type: replace
  path: /instance_groups/name=haproxy/networks/name=PAS-IPv6?
  value:
    name: PAS-IPv6
    static_ips:
    - 2601:0646:0100:69f5:0000:0000:0000:0010

# fixes "Error: Instance group 'haproxy' must specify which network is default for dns, gateway, since it has more than one network configured"
- type: replace
  path: /instance_groups/name=haproxy/networks/name=default/default?
  value:
    - dns
    - gateway

# configure haproxy to bind to the IPv6 in6addr_any address "::"
- type: replace
  path: /instance_groups/name=haproxy/jobs/name=haproxy/properties/ha_proxy/binding_ip?
  value: "::"

# configure haproxy to bind to both IPv4 & IPv6 interfaces
- type: replace
  path: /instance_groups/name=haproxy/jobs/name=haproxy/properties/ha_proxy/v4v6?
  value: true

# FIXME: delete this after our PR is merged
# https://github.com/cloudfoundry-incubator/haproxy-boshrelease/pull/151
- type: replace
  path: /releases/name=haproxy
  value:
    name: haproxy
    version: latest

# IPv4 must have the default route in order to reach the BOSH Director.  So how
# to assign IPv6 default route? Use swiss army knife release enable router
# advertisements so that the VM discovers the IPv6 default routes. Don't be
# tempted to use the networking release (IPv4 bias) or os-conf to set the
# sysctl's to enable router advertisementâ€”is uses the `sysctl --system` which
# wipes out the IPv6 address

- type: replace
  path: /releases/name=swiss-army-knife?
  value:
    name: swiss-army-knife
    sha1: e0ac6bdd4ae1a0674e4e0d3b5c9c3b7f8921ff62
    url: https://github.com/cloudfoundry-community/swiss-army-knife-release/releases/download/1.0.0/swiss-army-knife-release-1.0.0.tgz
    version: 1.0.0

- type: replace
  path: /instance_groups/name=haproxy/jobs/name=knife?
  value:
    name: knife
    release: swiss-army-knife
    properties:
      ctl: |
        #!/bin/bash -ex
        LOG_DIR=/var/vcap/sys/log/knife
        RUN_DIR=/var/vcap/sys/run/knife
        mkdir -p $RUN_DIR $LOG_DIR
        chown -R vcap:vcap $RUN_DIR $LOG_DIR
        exec >> $LOG_DIR/knife.stdout.log \
          2>> $LOG_DIR/knife.stderr.log
        PIDFILE=${RUN_DIR}/pid
        case $1 in
          start)
            echo 1 > $PIDFILE
            date +"%Y/%m/%d %H:%M:%S: STDOUT ctl start knife"
            date +"%Y/%m/%d %H:%M:%S: STDERR ctl start knife" 2>&1
            # get the default route by enabling
            # Neighbor Discover/Router Advertisements
            # override the unfortunate stemcell defaults in `/etc/sysctl.d/60-bosh-sysctl.conf`
            sysctl net.ipv6.conf.all.disable_ipv6=0
            sysctl net.ipv6.conf.default.disable_ipv6=0
            # accept router advertisements for both interfaces (IPv4 & IPv6)
            sysctl net.ipv6.conf.eth0.accept_ra=1
            sysctl net.ipv6.conf.eth1.accept_ra=1

            ;;
          stop)
            date +"%Y/%m/%d %H:%M:%S: STDOUT ctl stop knife"
            date +"%Y/%m/%d %H:%M:%S: STDERR ctl stop knife" 2>&1
            rm -f $PIDFILE

            ;;
        esac
